# Project Zomboid 手柄支持开发检查清单

## 📋 开发前检查

### 环境准备
- [ ] 确认目标游戏版本（B42.13+）
- [ ] 确认依赖模组已安装
- [ ] 准备测试手柄
- [ ] 启用调试模式

### 需求明确
- [ ] 确定需要支持的窗口类型
- [ ] 定义手柄按钮映射
- [ ] 确定兼容性要求
- [ ] 制定测试计划

## 🏗️ 开发阶段检查

### 代码结构
- [ ] 创建标准的模组目录结构
- [ ] 实现安全检查模块 `Safety`
- [ ] 实现按钮处理模块 `ButtonHandler`
- [ ] 实现窗口补丁模块 `WindowPatcher`
- [ ] 实现焦点管理模块 `FocusManager`

### 安全机制
- [ ] 所有外部调用都包装在 `pcall()` 中
- [ ] 实现 `isValidWindow()` 完整检查
- [ ] 添加对象销毁状态检查
- [ ] 实现安全焦点设置 `safeSetJoypadFocus()`

### 补丁实现
- [ ] 保存原始函数引用
- [ ] 非侵入式补丁设计
- [ ] 正确的错误处理
- [ ] 智能焦点管理

## 🧪 测试验证检查

### 单元测试
- [ ] 测试空对象检查
- [ ] 测试销毁对象检查
- [ ] 测试按钮映射
- [ ] 测试安全调用

### 集成测试
- [ ] 测试窗口补丁应用
- [ ] 测试手柄按钮响应
- [ ] 测试焦点切换
- [ ] 测试窗口关闭

### 兼容性测试
- [ ] 测试不同游戏版本
- [ ] 测试不同手柄类型
- [ ] 测试多玩家场景
- [ ] 测试与其他模组兼容性

### 压力测试
- [ ] 快速开关窗口测试
- [ ] 长时间游戏测试
- [ ] 内存泄漏检查
- [ ] 性能监控

## 🔧 优化完善检查

### 性能优化
- [ ] 检查循环效率
- [ ] 优化事件处理
- [ ] 减少无用计算
- [ ] 添加性能监控

### 错误处理
- [ ] 完善异常捕获
- [ ] 实现错误恢复
- [ ] 添加用户友好提示
- [ ] 记录详细错误日志

### 用户体验
- [ ] 智能焦点设置
- [ ] 直观的按钮映射
- [ ] 响应速度优化
- [ ] 操作反馈完善

## 📦 发布准备检查

### 代码质量
- [ ] 代码审查完成
- [ ] 注释完整清晰
- [ ] 变量命名规范
- [ ] 代码结构清晰

### 文档完善
- [ ] 更新 `mod.info`
- [ ] 编写使用说明
- [ ] 添加已知问题
- [ ] 准备更新日志

### 版本管理
- [ ] 确定版本号
- [ ] 标记兼容版本
- [ ] 准备发布包
- [ ] 测试发布包

## 🚨 常见问题检查

### 崩溃问题
- [ ] 检查所有空指针访问
- [ ] 验证对象生命周期
- [ ] 确认线程安全
- [ ] 测试边界条件

### 焦点问题
- [ ] 检查焦点设置逻辑
- [ ] 验证焦点切换流程
- [ ] 测试焦点丢失场景
- [ ] 确认焦点恢复机制

### 兼容性问题
- [ ] 检查依赖版本
- [ ] 验证API调用
- [ ] 测试冲突场景
- [ ] 确认降级方案

## 🎯 最佳实践确认

### 安全第一
- [ ] 所有可能出错的地方都有安全检查
- [ ] 错误不会导致游戏崩溃
- [ ] 异常情况有恢复机制
- [ ] 用户操作有反馈

### 非侵入设计
- [ ] 不修改原始代码
- [ ] 保持向后兼容
- [ ] 支持功能开关
- [ ] 易于卸载

### 可维护性
- [ ] 模块化设计
- [ ] 清晰的接口定义
- [ ] 完整的调试信息
- [ ] 详细的代码注释

## 📊 质量评估

### 代码质量评分
- [ ] 安全性: ⭐⭐⭐⭐⭐
- [ ] 性能: ⭐⭐⭐⭐⭐
- [ ] 可维护性: ⭐⭐⭐⭐⭐
- [ ] 用户体验: ⭐⭐⭐⭐⭐

### 测试覆盖率
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖主要场景
- [ ] 边界条件测试完整
- [ ] 错误场景测试充分

## ✅ 发布确认

### 最终检查
- [ ] 所有测试通过
- [ ] 性能指标达标
- [ ] 用户反馈良好
- [ ] 文档准备齐全

### 发布前确认
- [ ] 版本号正确
- [ ] 兼容性声明准确
- [ ] 更新日志完整
- [ ] 发布包测试通过

---

## 🎯 快速参考

### 关键函数模板
```lua
-- 安全检查
if not Safety.isValidWindow(window) then return false end

-- 安全调用
local success, result = pcall(func, ...)
if not success then return false end

-- 安全焦点设置
Safety.safeSetJoypadFocus(playerNum, target)
```

### 调试命令
```lua
-- 启用调试模式
ControllerSupport.state.debugMode = true

-- 检查状态
print("手柄支持状态: " .. tostring(ControllerSupport.state.isActive))
```

### 常见修复
- 空指针异常 → 添加 `isValidWindow()` 检查
- 焦点丢失 → 使用 `safeSetJoypadFocus()`
- 对象销毁 → 检查 `javaObject:isDestroyed()`
- 无限循环 → 添加超时机制

---

**使用说明**: 在每个开发阶段完成后，对照此清单进行检查，确保所有关键点都已覆盖。这能大大提高手柄支持模组的质量和稳定性。